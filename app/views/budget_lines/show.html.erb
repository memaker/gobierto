<%= render partial: 'places/place_header' %>

<header class="sub">

  <span class="sep"><%= link_to kind_literal(@kind).capitalize, place_budget_path(@place.slug, @year, @kind, @area_name) %> »</span>
  <%= render partial: 'breadcrumb', 
            collection: budget_line_crumbs(@parent_line),
            as: 'budget_line', 
            spacer_template: 'breadcrumb_spacer' %> 

</header>

<div class="main_metrics clearfix">
  <div class="metric selected tipsit" data-widget-template="#widget-template"
                                      title="Gasto total de esta partida en este año"
                                      data-widget-type="budget"
                                      data-line-widget-url="<%= api_data_lines_path(@place.id, @year, "total_budget", kind: @kind, code: @code, area: @area_name, format: :json ) %>"
                                      data-line-widget-type="total_budget"
                                      data-widget-data-url="<%= api_data_budget_path(ine_code: @place.id, year: @year, kind: @kind, code: @code, area: @area_name, format: :json) %>">
  </div>

  <div class="metric tipsit" data-widget-template="#widget-template"
                             title="Gasto total de esta partida en este año por habitante"
                             data-widget-type="budget_per_inhabitant"
                             data-line-widget-url="<%= api_data_lines_path(@place.id, @year, "per_person", kind: @kind, code: @code, area: @area_name, format: :json ) %>"
                             data-line-widget-type="per_person"
                             data-widget-data-url="<%= api_data_budget_per_inhabitant_path(ine_code: @place.id, year: @year, kind: @kind, code: @code, area: @area_name, format: :json) %>">
  </div>

  <div class="metric">
    <div class="label">Porcentaje sobre el total</div>
    <div class="main">35%</div>
    <div class="secondary">
    </div>
  </div>

  <div class="metric tipsit" data-graph-show="5" title="Compara con otros municipios">
    <div class="label">Diferencia con la media</div>
    <div class="main">-13,45%</div>
    <div class="secondary">
    </div>
  </div>

  <div class="metric">
  </div>
</div>

<div class="metric_graphs clearfix">
  <div class="graph">
    <div id="lines_chart"></div>
    <div id="lines_tooltip"></div>
  </div>
</div>

<div class="items">
  <table>
  <tr>
    <th>
      <input type="text" placeholder="Busca partidas" class="search_items">
    </th>
    <th class="right ">Gasto total</th>
    <th class="right ">Gasto por hab.</th>
    <th class="right ">% s/ total</th>
    <th></th>
  </tr>

  <tr>
    <td class="item_name" colspan="4">
      <%= link_to '« Inicio', place_budget_path(@place.slug, @year, @kind, @area_name) %>
    </td>
  </tr>
  
  <%= render partial: 'places/nested_budget_lines' %>
  
  </table>
</div>

<script type="text/html" id="widget-template">
  <div class="label">{{title}}</div>
  <div class="main">{{value}}</div>
  <div class="secondary">
    <div class="percentage_change up">{{delta_percentage}}%</div>
    <div class="ranking"><strong>#{{ranking_position}}</strong>/{{ranking_total_elements}}</div>
  </div>
</script>

<script>
$(function(){
  var visLineasJ = new VisLineasJ('#lines_chart', '#lines_tooltip', 'total_budget');
  visLineasJ.render($('[data-line-widget-url].selected').data('line-widget-url'));

  $('[data-line-widget-url]').on('click', function(e){
    e.preventDefault();
    visLineasJ.measure = $(this).data('line-widget-type');
    visLineasJ.render($(this).data('line-widget-url'));
  });

  d3.selectAll('.measure.button')
    .on('click', function(d) {
      d3.selectAll(".measure.button.buttonSelected").classed("buttonSelected", false);
      d3.select(this).classed("buttonSelected", true);
      visLineasJ.measure = this.id;

      visLineasJ.updateRender();
    });

  d3.selectAll('.context.button')
    .on('click', function(d) {
      d3.selectAll(".context.button.buttonSelected").classed("buttonSelected", false);
      d3.select(this).classed("buttonSelected", true);
      visLineasJ.mean = this.id;

      visLineasJ.updateRender();
    });
});
</script>
