<%
  @title = "Presupuestos municipales de #{@place.name} del #{@year}"
  set_meta_tags title: @title
  set_meta_tags description: "Consulta y visualiza los presupuestos municipales de #{@place.name} del #{@year}. Consulta gastos e ingresos, indicadores presupuestarios, datos de ejecución..."
%>

<%= render partial: 'place_header' %>

<div class="main_metrics clearfix">

  <div class="metric selected"
    data-widget-template="#widget-template"
    data-widget-type="per_person"
    data-line-widget-series="means"
    data-line-widget-url="<%= api_data_lines_path(ine_code: @place.id, year: @year, what: 'per_person', format: :json) %>"
    data-line-widget-type="per_person"
    data-widget-data-url="<%= api_data_total_budget_per_inhabitant_path(ine_code: @place.id, year: @year, format: :json) %>">
  </div>

  <div class="metric"
    data-widget-template="#widget-template"
    data-widget-type="total_budget"
    data-line-widget-series="means"
    data-line-widget-url="<%= api_data_lines_path(ine_code: @place.id, year: @year, what: 'total_budget', format: :json) %>"
    data-line-widget-type="total_budget"
    data-widget-data-url="<%= api_data_total_budget_path(ine_code: @place.id, year: @year, format: :json) %>">
  </div>

  <div class="metric"
    data-widget-template="#widget-template"
    data-widget-type="population"
    data-widget-data-url="<%= api_data_population_path(ine_code: @place.id, year: @year, format: :json) %>">
  </div>

  <div class="metric"
    data-widget-template="#widget-template-no-ranking"
    data-widget-type="total_budget_execution"
    data-widget-data-url="<%= api_data_total_budget_execution_path(ine_code: @place.id, year: @year, format: :json) %>">
  </div>

  <div class="metric"></div>
</div>

<div class="metric_graphs clearfix">
  <div class="widget_graph show clearfix">
    <div class="col-1-2" id="lines_chart"></div>
    <div class="col-2-2">
      <div id="lines_tooltip"></div>
      <div class="help">
        <%= link_to 'Nota sobre los datos'.html_safe, faq_path(anchor: 'no_data'), title: 'La base de datos que utilizamos no incluye datos para el 100% de los municipios, por lo que las medias están calculadas solo con los datos que existen (que son la gran mayoría). Más información en nuestras preguntas frecuentes', class: 'tipsit' %>
      </div>
    </div>
  </div>
</div>

<div class="section_separator" name="separator">
  <div class="sep"></div>
  Explora ingresos y gastos de <%= @place.name %>
  <div class="sep"></div>
</div>

<div class="ie_intro clearfix">

  <div class="cont-expenses">
    <header class="cat expenses">
      <h2><%= link_to 'Ingresos', '#', data: {rel: 'cont-switch', target: 'cont-income'} %></h2>
      <span class="sep">|</span>
      <h2>Gastos</h2>

      <div class="form_filters">
        <ul>
          <li><%= link_to 'Económica', place_path(@place.slug, @year, {area: 'economic'}), remote: true, class: 'toggle', id: 'Economica' %></li>
          <li><%= link_to 'Funcional', place_path(@place.slug, @year, {area: 'functional'}), remote: true, class: 'toggle buttonSelected', id: 'Funcional' %></li>
        </ul>
      </div>

      <div id="total_expense_budget" class="qty"><%= number_to_currency @expense_lines['aggregations']['total_budget']['value'], precision: 0 %></div>
    </header>

    <div class="graph" id="expense-treemap"
                       data-functional-url="<%= place_budget_path(@place.slug, @year, BudgetLine::EXPENSE, 'functional', format: :json) %>"
                       data-economic-url="<%= place_budget_path(@place.slug, @year, BudgetLine::EXPENSE, 'economic', format: :json) %>">
    </div>

    <div class="items">
      <table id="expense_lines">
        <%= render partial: 'places/expense_lines', locals: { area_name: @area_name } %>
      </table>
    </div>
  </div>

  <div class="cont-income hidden">
    <header class="cat incomes">
      <h2>Ingresos</h2>
      <span class="sep">|</span>
      <h2><%= link_to 'Gastos', '#', data: {rel: 'cont-switch', target: 'cont-expenses'} %></h2>
      <div class="qty"><%= number_to_currency @income_lines['aggregations']['total_budget']['value'], precision: 0 %></div>
    </header>

    <div class="graph" id="income-treemap" data-economic-url="<%= place_budget_path(@place.slug, @year, BudgetLine::INCOME, 'economic', format: :json) %>">
    </div>

    <div class="items">
      <table>
      <tr>
        <th>
          <input type="text" placeholder="Busca partidas de ingresos" class="search_items search_categories_budget-income" data-search-url="<%= search_categories_path(@place.slug,@year, 'economic', BudgetLine::INCOME) %>">
        </th>
        <th class="right "><%= kind_literal(BudgetLine::INCOME, false) %> total</th>
        <th class="right "><%= kind_literal(BudgetLine::INCOME, false) %> por hab.</th>
        <th class="right ">% s/ total</th>
        <th class="bar_cont"></th>
      </tr>
      <%= render partial: 'places/budget_lines',
                  collection: @income_lines['hits'],
                  as: 'budget_line',
                  locals: { total_budget: @income_lines['aggregations']['total_budget']['value'], kind: BudgetLine::INCOME, area_name: 'economic' } %>
      </table>
    </div>
  </div>
</div>

<% if current_user_admin? %>
  <strong style="color:red">Admin only</strong>
  <table>
    <thead>
      <tr style="font-weight:bold">
        <td colspan="2">¿Qué ingresos tiene tu ayuntamiento?</td>
        <td colspan="2">¿En qué se los gasta?</td>
      </tr>
    </thead>
    <% total_budget = @income_lines['aggregations']['total_budget']['value'] %>
    <!-- <%= total_budget %> -->
    <% income_entries, expense_entries = BudgetLine.top_values({year: @year, ine_code: @place.id}) %>
    <tbody>
      <% 0.upto(income_entries.length - 1) do |i| %>
        <tr>
          <td><%= budget_line_denomination 'economic', income_entries[i]['code'], BudgetLine::INCOME %></td>
          <td><%= percentage_of_total income_entries[i]['amount'], total_budget %>%</td>
          <td><%= budget_line_denomination 'functional', expense_entries[i]['code'], BudgetLine::EXPENSE %></td>
          <td><%= percentage_of_total expense_entries[i]['amount'], total_budget %>%</td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<% unless logged_in? %>
  <%= render 'places/cta_block' %>
<% end %>


<div class="featured_budget_line">

  <h3 class="lite">Partidas destacadas</h3>

  <div class="cont clearfix">

    <div class="main">
      
      <header>
        ¿Cuánto se gasta Madrid en...
        <h2>Limpieza viaria?</h2>
      </header>

      <div class="main_metrics clearfix">

        <div class="metric" data-graph-show="1" title="Gasto total de esta partida en este año">
          <div class="label">Gasto por habitante</div>
          <div class="main">128,4M€</div>
          <div class="secondary">
            <div class="percentage_change up">3,23%</div>
            <div class="ranking"><strong>#12</strong>/8.234</div>
          </div>
        </div>

        <div class="metric" data-graph-show="1" title="Gasto total de esta partida en este año">
          <div class="label">Gasto total</div>
          <div class="main">128,4M€</div>
          <div class="secondary">
            <div class="percentage_change up">3,23%</div>
            <div class="ranking"><strong>#12</strong>/8.234</div>
          </div>
        </div>

        <div class="metric" data-graph-show="1" title="Gasto total de esta partida en este año">
          <div class="label">Porcentaje sobre el total</div>
          <div class="main">0,79%</div>
        </div>

      </div>

    </div>

    <div class="act">

      <header>
        <div>¿Entiendes de qué va esta partida?</div>
        <div>¿Te parece mucho, poco?</div>
      </header>

      <%= link_to 'Levanta la mano: opina', '', class: 'button user' %>

    </div>

  </div>

  <%= link_to 'Enséñame otra', '', class: 'show_me_another' %>

</div>


<script type="text/html" id="widget-template">
  <div class="label">{{title}}</div>
  <div class="main {{sign}}">{{value}}</div>
  <div class="secondary">
    <div class="percentage_change up {{sign}}">{{delta_percentage}}%</div>
    <div class="ranking"><a href="{{ranking_url}}"><strong>#{{ranking_position}}</strong>/{{ranking_total_elements}}</a></div>
  </div>
</script>

<script type="text/html" id="widget-template-no-ranking">
  <div class="label">{{title}}</div>
  <div class="main {{sign}}">{{delta_percentage}} %</div>
  <div class="secondary">
    <div class="percentage_change up {{sign}}">{{value}}</div>
  </div>
</script>
